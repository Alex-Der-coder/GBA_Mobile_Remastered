"use strict";function registerGUIEvents(){IodineGUI.Iodine.attachPlayStatusHandler(updatePlayButton),addEvent("keydown",document,keyDown),addEvent("keyup",document,keyUpPreprocess),addEvent("change",document.getElementById("rom_load"),fileLoadROM),addEvent("change",document.getElementById("bios_load"),fileLoadBIOS),addEvent("click",document.getElementById("play"),(function(e){IodineGUI.Iodine.play()})),addEvent("click",document.getElementById("pause"),(function(e){IodineGUI.Iodine.pause()})),addEvent("click",document.getElementById("restart"),(function(e){IodineGUI.Iodine.restart()})),addEvent("click",document.getElementById("sound"),(function(){setValue("sound",!!this.checked),this.checked?IodineGUI.Iodine.enableAudio():IodineGUI.Iodine.disableAudio()})),addEvent("click",document.getElementById("skip_boot"),(function(){setValue("skipBoot",!!this.checked),IodineGUI.Iodine.toggleSkipBootROM(this.checked)})),addEvent("click",document.getElementById("toggleSmoothScaling"),(function(){setValue("toggleSmoothScaling",!!this.checked),IodineGUI.Blitter&&IodineGUI.Blitter.setSmoothScaling(this.checked)})),addEvent("click",document.getElementById("toggleDynamicSpeed"),(function(){setValue("toggleDynamicSpeed",!!this.checked),IodineGUI.Iodine.toggleDynamicSpeed(this.checked)})),addEvent("click",document.getElementById("offthread-gpu"),(function(){setValue("toggleOffthreadGraphics",!!this.checked),IodineGUI.Iodine.toggleOffthreadGraphics(this.checked)})),addEvent("click",document.getElementById("offthread-cpu"),(function(){setValue("toggleOffthreadCPU",!!this.checked)})),addEvent("change",document.getElementById("speedset"),speedChangeFunc),addEvent("input",document.getElementById("speedset"),speedChangeFunc),addEvent("click",document.getElementById("fullscreen"),toggleFullScreen);let e=[{key:0,elem:document.getElementById("touch-a"),touches:[],timestamp:[]},{key:1,elem:document.getElementById("touch-b"),touches:[],timestamp:[]},{key:2,elem:document.getElementById("touch-select"),touches:[],timestamp:[]},{key:3,elem:document.getElementById("touch-start"),touches:[],timestamp:[]},{key:4,elem:document.getElementById("touch-right"),touches:[],timestamp:[]},{key:5,elem:document.getElementById("touch-left"),touches:[],timestamp:[]},{key:6,elem:document.getElementById("touch-up"),touches:[],timestamp:[]},{key:7,elem:document.getElementById("touch-down"),touches:[],timestamp:[]},{key:8,elem:document.getElementById("touch-r"),touches:[],timestamp:[]},{key:9,elem:document.getElementById("touch-l"),touches:[],timestamp:[]}];addEvent("touchstart",document,(function(t){for(const n of e){let e=t.changedTouches,d=!1;for(let o=0;o<e.length;o++){document.elementFromPoint(e[o].pageX,e[o].pageY)===n.elem&&(t.preventDefault(),d=!0),!n.touches.includes(e[o].identifier)&&d&&(n.touches.push(e[o].identifier),1===n.touches.length&&(n.timestamp[e[o].identifier]=IodineGUI.Iodine.lastTimestamp,IodineGUI.Iodine.keyDown(n.key),n.elem.classList.add("pressed")))}}})),addEvent("touchmove",document,(function(t){for(const n of e){let e=t.changedTouches,d=!1;for(let t=0;t<e.length;t++){document.elementFromPoint(e[t].pageX,e[t].pageY)===n.elem&&(d=!0),!n.touches.includes(e[t].identifier)&&d?(n.touches.push(e[t].identifier),1===n.touches.length&&(IodineGUI.Iodine.keyDown(n.key),n.elem.classList.add("pressed"))):n.touches.includes(e[t].identifier)&&!d&&(n.touches.splice(n.touches.indexOf(e[t].identifier),1),0===n.touches.length&&(IodineGUI.Iodine.keyUp(n.key),n.elem.classList.remove("pressed")))}}}));let t=function(t){for(const n of e){let e=t.changedTouches;for(let t=0;t<e.length;t++)if(n.touches.includes(e[t].identifier)){if(n.touches.splice(n.touches.indexOf(e[t].identifier),1),0===n.touches.length){let d=IodineGUI.Iodine.lastTimestamp-n.timestamp[e[t].identifier];n.timestamp[e[t].identifier]=null,d>0?(IodineGUI.Iodine.keyUp(n.key),n.elem.classList.remove("pressed")):setTimeout((()=>{console.log("delayed release"),0===n.touches.length&&(IodineGUI.Iodine.keyUp(n.key),n.elem.classList.remove("pressed"))}),1)}}else{document.elementFromPoint(e[t].pageX,e[t].pageY)===n.elem&&(IodineGUI.Iodine.keyDown(n.key),n.elem.classList.add("pressed"),setTimeout((()=>{console.log("delayed release2"),IodineGUI.Iodine.keyUp(n.key),n.elem.classList.remove("pressed")}),1))}}};addEvent("touchend",document,t),addEvent("touchcancel",document,t),addEvent("click",document.getElementById("key_a"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=0})),addEvent("click",document.getElementById("key_b"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=1})),addEvent("click",document.getElementById("key_select"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=2})),addEvent("click",document.getElementById("key_start"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=3})),addEvent("click",document.getElementById("key_right"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=4})),addEvent("click",document.getElementById("key_left"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=5})),addEvent("click",document.getElementById("key_up"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=6})),addEvent("click",document.getElementById("key_down"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=7})),addEvent("click",document.getElementById("key_r"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=8})),addEvent("click",document.getElementById("key_l"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesGBA,IodineGUI.toMapIndice=9})),addEvent("click",document.getElementById("key_volumedown"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=0})),addEvent("click",document.getElementById("key_volumeup"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=1})),addEvent("click",document.getElementById("key_speedup"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=2})),addEvent("click",document.getElementById("key_slowdown"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=3})),addEvent("click",document.getElementById("key_speedreset"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=4})),addEvent("click",document.getElementById("key_fullscreen"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=5})),addEvent("click",document.getElementById("key_playpause"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=6})),addEvent("click",document.getElementById("key_restart"),(function(){IodineGUI.toMap=IodineGUI.defaults.keyZonesControl,IodineGUI.toMapIndice=7})),addEvent("change",document.getElementById("import"),(function(e){if(void 0!==this.files)try{if(this.files.length>=1){writeRedTemporaryText('Reading the local file "'+this.files[0].name+'" for importing.');try{var t=new FileReader;t.onload=function(){if(2==this.readyState){writeRedTemporaryText("file imported.");try{import_save(this.result)}catch(e){writeRedTemporaryText(e.message+" file: "+e.fileName+" line: "+e.lineNumber)}}else writeRedTemporaryText("importing file, please wait...")},t.readAsBinaryString(this.files[this.files.length-1])}catch(e){var n=this.files[this.files.length-1].getAsBinary();try{import_save(n)}catch(e){writeRedTemporaryText(e.message+" file: "+e.fileName+" line: "+e.lineNumber)}}}else writeRedTemporaryText("Incorrect number of files selected for local loading.")}catch(e){writeRedTemporaryText("Could not load in a locally stored ROM file.")}else writeRedTemporaryText("could not find the handle on the file to open.");e.preventDefault&&e.preventDefault()})),addEvent("click",document.getElementById("export"),refreshStorageListing),addEvent("unload",window,ExportSave),IodineGUI.Iodine.attachSpeedHandler((function(e){(e=e.toFixed(2))!=IodineGUI.currentSpeed[1]&&(IodineGUI.currentSpeed[1]=e,IodineGUI.currentSpeed[0]=!0)})),addEvent("change",document.getElementById("volume"),volChangeFunc),addEvent("input",document.getElementById("volume"),volChangeFunc),addEvent("resize",window,resizeCanvasFunc),addEvent("mouseover",document.getElementById("saves_menu"),rebuildSavesMenu),void 0!==document.hidden?addEvent("visibilitychange",document,visibilityChangeHandle):void 0!==document.mozHidden?addEvent("mozvisibilitychange",document,mozVisibilityChangeHandle):void 0!==document.msHidden?addEvent("msvisibilitychange",document,msVisibilityChangeHandle):void 0!==document.webkitHidden&&addEvent("webkitvisibilitychange",document,webkitVisibilityChangeHandle),resizeCanvasFunc()}function registerDefaultSettings(){null===findValue("sound")?setValue("sound",!!IodineGUI.defaults.sound):IodineGUI.defaults.sound=!!findValue("sound"),null===findValue("volume")?setValue("volume",+IodineGUI.defaults.volume):IodineGUI.defaults.volume=+findValue("volume"),document.getElementById("volume").value=Math.round(100*IodineGUI.defaults.volume),document.getElementById("speedset").value=50,null===findValue("skipBoot")?setValue("skipBoot",!!IodineGUI.defaults.skipBoot):IodineGUI.defaults.skipBoot=!!findValue("skipBoot"),null===findValue("toggleSmoothScaling")?setValue("toggleSmoothScaling",!!IodineGUI.defaults.toggleSmoothScaling):IodineGUI.defaults.toggleSmoothScaling=!!findValue("toggleSmoothScaling"),null===findValue("toggleDynamicSpeed")?setValue("toggleDynamicSpeed",!!IodineGUI.defaults.toggleDynamicSpeed):IodineGUI.defaults.toggleDynamicSpeed=!!findValue("toggleDynamicSpeed"),null===findValue("toggleOffthreadGraphics")?setValue("toggleOffthreadGraphics",!!IodineGUI.defaults.toggleOffthreadGraphics):IodineGUI.defaults.toggleOffthreadGraphics=!!findValue("toggleOffthreadGraphics"),null===findValue("toggleOffthreadCPU")?setValue("toggleOffthreadCPU",!!IodineGUI.defaults.toggleOffthreadCPU):IodineGUI.defaults.toggleOffthreadCPU=!!findValue("toggleOffthreadCPU"),null===findValue("key_a")?setValue("key_a",0|IodineGUI.defaults.keyZonesGBA[0]):IodineGUI.defaults.keyZonesGBA[0]=findValue("key_a"),null===findValue("key_b")?setValue("key_b",0|IodineGUI.defaults.keyZonesGBA[1]):IodineGUI.defaults.keyZonesGBA[1]=findValue("key_b"),null===findValue("key_select")?setValue("key_select",0|IodineGUI.defaults.keyZonesGBA[2]):IodineGUI.defaults.keyZonesGBA[2]=findValue("key_select"),null===findValue("key_start")?setValue("key_start",0|IodineGUI.defaults.keyZonesGBA[3]):IodineGUI.defaults.keyZonesGBA[3]=findValue("key_start"),null===findValue("key_right")?setValue("key_right",0|IodineGUI.defaults.keyZonesGBA[4]):IodineGUI.defaults.keyZonesGBA[4]=findValue("key_right"),null===findValue("key_left")?setValue("key_left",0|IodineGUI.defaults.keyZonesGBA[5]):IodineGUI.defaults.keyZonesGBA[5]=findValue("key_left"),null===findValue("key_up")?setValue("key_up",0|IodineGUI.defaults.keyZonesGBA[6]):IodineGUI.defaults.keyZonesGBA[6]=findValue("key_up"),null===findValue("key_down")?setValue("key_down",0|IodineGUI.defaults.keyZonesGBA[7]):IodineGUI.defaults.keyZonesGBA[7]=findValue("key_down"),null===findValue("key_r")?setValue("key_r",0|IodineGUI.defaults.keyZonesGBA[8]):IodineGUI.defaults.keyZonesGBA[8]=findValue("key_r"),null===findValue("key_l")?setValue("key_l",0|IodineGUI.defaults.keyZonesGBA[9]):IodineGUI.defaults.keyZonesGBA[9]=findValue("key_l"),null===findValue("key_volumedown")?setValue("key_volumedown",0|IodineGUI.defaults.keyZonesControl[0]):IodineGUI.defaults.keyZonesControl[0]=findValue("key_volumedown"),null===findValue("key_volumeup")?setValue("key_volumeup",0|IodineGUI.defaults.keyZonesControl[1]):IodineGUI.defaults.keyZonesControl[1]=findValue("key_volumeup"),null===findValue("key_speedup")?setValue("key_speedup",0|IodineGUI.defaults.keyZonesControl[2]):IodineGUI.defaults.keyZonesControl[2]=findValue("key_speedup"),null===findValue("key_slowdown")?setValue("key_slowdown",0|IodineGUI.defaults.keyZonesControl[3]):IodineGUI.defaults.keyZonesControl[3]=findValue("key_slowdown"),null===findValue("key_speedreset")?setValue("key_speedreset",0|IodineGUI.defaults.keyZonesControl[4]):IodineGUI.defaults.keyZonesControl[4]=findValue("key_speedreset"),null===findValue("key_fullscreen")?setValue("key_fullscreen",0|IodineGUI.defaults.keyZonesControl[5]):IodineGUI.defaults.keyZonesControl[5]=findValue("key_fullscreen"),null===findValue("key_playpause")?setValue("key_playpause",0|IodineGUI.defaults.keyZonesControl[6]):IodineGUI.defaults.keyZonesControl[6]=findValue("key_playpause"),null===findValue("key_restart")?setValue("key_restart",0|IodineGUI.defaults.keyZonesControl[7]):IodineGUI.defaults.keyZonesControl[7]=findValue("key_restart")}function saveKeyBindings(){setValue("key_a",0|IodineGUI.defaults.keyZonesGBA[0]),setValue("key_b",0|IodineGUI.defaults.keyZonesGBA[1]),setValue("key_select",0|IodineGUI.defaults.keyZonesGBA[2]),setValue("key_start",0|IodineGUI.defaults.keyZonesGBA[3]),setValue("key_right",0|IodineGUI.defaults.keyZonesGBA[4]),setValue("key_left",0|IodineGUI.defaults.keyZonesGBA[5]),setValue("key_up",0|IodineGUI.defaults.keyZonesGBA[6]),setValue("key_down",0|IodineGUI.defaults.keyZonesGBA[7]),setValue("key_r",0|IodineGUI.defaults.keyZonesGBA[8]),setValue("key_l",0|IodineGUI.defaults.keyZonesGBA[9]),setValue("key_volumedown",0|IodineGUI.defaults.keyZonesControl[0]),setValue("key_volumeup",0|IodineGUI.defaults.keyZonesControl[1]),setValue("key_speedup",0|IodineGUI.defaults.keyZonesControl[2]),setValue("key_slowdown",0|IodineGUI.defaults.keyZonesControl[3]),setValue("key_speedreset",0|IodineGUI.defaults.keyZonesControl[4]),setValue("key_fullscreen",0|IodineGUI.defaults.keyZonesControl[5]),setValue("key_playpause",0|IodineGUI.defaults.keyZonesControl[6]),setValue("key_restart",0|IodineGUI.defaults.keyZonesControl[7])}function registerGUISettings(){document.getElementById("sound").checked=IodineGUI.defaults.sound,IodineGUI.defaults.sound&&IodineGUI.Iodine.enableAudio();try{var e=document.getElementById("volume");e.min=0,e.max=100,e.step=1,e.value=100*IodineGUI.defaults.volume}catch(e){}IodineGUI.mixerInput.setVolume(IodineGUI.defaults.volume),document.getElementById("skip_boot").checked=IodineGUI.defaults.skipBoot,IodineGUI.Iodine.toggleSkipBootROM(IodineGUI.defaults.skipBoot),document.getElementById("toggleSmoothScaling").checked=IodineGUI.defaults.toggleSmoothScaling,IodineGUI.Blitter.setSmoothScaling(IodineGUI.defaults.toggleSmoothScaling),document.getElementById("toggleDynamicSpeed").checked=IodineGUI.defaults.toggleDynamicSpeed,IodineGUI.Iodine.toggleDynamicSpeed(IodineGUI.defaults.toggleDynamicSpeed),document.getElementById("offthread-gpu").checked=IodineGUI.defaults.toggleOffthreadGraphics,IodineGUI.Iodine.toggleOffthreadGraphics(IodineGUI.defaults.toggleOffthreadGraphics),document.getElementById("offthread-cpu").checked=IodineGUI.defaults.toggleOffthreadCPU,"function"==typeof SharedArrayBuffer&&"object"==typeof Atomics||(document.getElementById("offthread-gpu").disabled=!0,document.getElementById("offthread-cpu").disabled=!0)}function updatePlayButton(e){1==(0|(e|=0))?(document.getElementById("play").className="hide",document.getElementById("pause").className="show",document.getElementById("menu").className="playing",IodineGUI.coreTimerID||startTimer(),IodineGUI.isPlaying=!0):(document.getElementById("pause").className="hide",document.getElementById("play").className="show",document.getElementById("menu").className="paused",IodineGUI.coreTimerID&&(clearInterval(IodineGUI.coreTimerID),IodineGUI.coreTimerID=null),IodineGUI.isPlaying=!1)}function visibilityChangeHandle(){processVisibilityChange(document.hidden)}function mozVisibilityChangeHandle(){processVisibilityChange(document.mozHidden)}function msVisibilityChangeHandle(){processVisibilityChange(document.msHidden)}function webkitVisibilityChangeHandle(){processVisibilityChange(document.webkitHidden)}function processVisibilityChange(e){e?"hide"==document.getElementById("play").className&&(IodineGUI.Iodine.pause(),IodineGUI.suspended=!0):IodineGUI.suspended&&(IodineGUI.suspended=!1,IodineGUI.Iodine.play())}function stepVolume(e){var t=document.getElementById("volume").value/100;t=Math.min(Math.max(t+e,0),1),IodineGUI.mixerInput.setVolume(t),document.getElementById("volume").value=Math.round(100*t)}function volChangeFunc(){var e=.01*Math.min(Math.max(parseInt(this.value),0),100);setValue("volume",+e),IodineGUI.mixerInput.setVolume(+e)}function speedChangeFunc(){var e=Math.min(Math.max(parseInt(this.value),0),100)/50;e*=e,IodineGUI.Iodine.setSpeed(+e)}function writeRedTemporaryText(e){IodineGUI.GUITimerID&&clearTimeout(IodineGUI.GUITimerID),document.getElementById("tempMessage").style.display="block",document.getElementById("tempMessage").textContent=e,IodineGUI.GUITimerID=setTimeout(clearTempString,5e3)}function clearTempString(){document.getElementById("tempMessage").style.display="none"}function resizeCanvasFunc(){var e=document.getElementById("main"),t=e.clientHeight||e.offsetHeight||0,n=e.clientWidth||e.offsetWidth||0;if(t>0&&n>0){var d=document.getElementById("emulator_target"),o=Math.floor(1.5*t),i=Math.floor(n/1.5),l=Math.min(i,t),a=Math.min(o,n);d.style.width=a+"px",d.style.height=l+"px"}}function rebuildSavesMenu(e){didNotEnter(document.getElementById("saves_menu_container"),e)&&(ExportSave(),rebuildExistingSaves(),e.preventDefault&&e.preventDefault())}function rebuildExistingSaves(){var e=document.getElementById("existing_saves_list");ExportSave(),removeChildNodes(e);for(var t=getSavesKeys();t.length>0;)addExistingSaveItem(e,t.shift())}function addExistingSaveItem(e,t){var n=document.createElement("li");n.className="nowrap";var d=document.createElement("span");d.textContent=decodeKeyType(t),n.appendChild(d);var o=document.createElement("ul"),i=document.createElement("li");i.className="nowrap",addEvent("click",i,(function(){deleteValue(t),rebuildExistingSaves()}));var l=document.createElement("span");l.textContent="Delete",i.appendChild(l),o.appendChild(i);var a=document.createElement("li");a.className="nowrap";var s=document.createElement("a");s.href="data:application/octet-stream;base64,"+base64(generateBlob(t,findValue(t))),s.download=t+"_"+(new Date).getTime()+".export",s.textContent="Download as import compatible",a.appendChild(s),o.appendChild(a);var u=document.createElement("li");u.className="nowrap";var I=document.createElement("a");I.href="data:application/octet-stream;base64,"+findValue(t),I.download=t+"_"+(new Date).getTime()+".sav",I.textContent="Download as raw binary",u.appendChild(I),o.appendChild(u),n.appendChild(o),e.appendChild(n)}function decodeKeyType(e){return"SAVE_TYPE_GUID_"==e.substring(0,15)?'Game "'+e.substring(15)+'" Type Code':"SAVE_GUID_"==e.substring(0,10)?'Game "'+e.substring(10)+'" Cartridge Data':"SAVE_RTC_GUID_"==e.substring(0,15)?'Game "'+e.substring(15)+'" RTC Data':e}function removeChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function didNotEnter(e,t){for(var n=void 0!==t.target?t.target:t.srcElement;n;){if(isSameNode(n,e))return!1;n=n.parentElement}return!0}function isSameNode(e,t){return"function"==typeof e.isSameNode?e.isSameNode(t):e===t}function addEvent(e,t,n){try{t.addEventListener(e,n,!1)}catch(d){t.attachEvent("on"+e,n)}}function removeEvent(e,t,n){try{t.removeEventListener(e,n,!1)}catch(d){t.detachEvent("on"+e,n)}}
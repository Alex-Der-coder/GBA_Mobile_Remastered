"use strict";importScripts("../includes/TypedArrayShim.js"),importScripts("Cartridge.js"),importScripts("DMA.js"),importScripts("Emulator.js"),importScripts("Graphics.js"),importScripts("RunLoop.js"),importScripts("Memory.js"),importScripts("IRQ.js"),importScripts("JoyPad.js"),importScripts("Serial.js"),importScripts("Sound.js"),importScripts("Timer.js"),importScripts("Wait.js"),importScripts("CPU.js"),importScripts("Saves.js"),importScripts("sound/FIFO.js"),importScripts("sound/Channel1.js"),importScripts("sound/Channel2.js"),importScripts("sound/Channel3.js"),importScripts("sound/Channel4.js"),importScripts("CPU/ARM.js"),importScripts("CPU/THUMB.js"),importScripts("CPU/CPSR.js"),importScripts("graphics/RendererProxy.js"),importScripts("graphics/RendererShim.js"),importScripts("graphics/Renderer.js"),importScripts("graphics/BGTEXT.js"),importScripts("graphics/BG2FrameBuffer.js"),importScripts("graphics/BGMatrix.js"),importScripts("graphics/AffineBG.js"),importScripts("graphics/ColorEffects.js"),importScripts("graphics/Mosaic.js"),importScripts("graphics/OBJ.js"),importScripts("graphics/OBJWindow.js"),importScripts("graphics/Window.js"),importScripts("graphics/Compositor.js"),importScripts("memory/DMA0.js"),importScripts("memory/DMA1.js"),importScripts("memory/DMA2.js"),importScripts("memory/DMA3.js"),importScripts("cartridge/SaveDeterminer.js"),importScripts("cartridge/SRAM.js"),importScripts("cartridge/FLASH.js"),importScripts("cartridge/EEPROM.js"),importScripts("cartridge/GPIO.js");var Iodine=new GameBoyAdvanceEmulator,saveImportPool=[],gfxBuffers=[getSharedUint8Array(115200),getSharedUint8Array(115200)],gfxCounters=getSharedInt32Array(3),audioBuffer=null,audioCounters=null,audioBufferSize=0,audioBufferSizeMask=0,audioSamplesRemaining=getSharedInt32Array(1),timestamp=getSharedUint32Array(1),timerHandle=null,timerRate=0;try{postMessage({messageID:0,gfxBuffer1:gfxBuffers[0],gfxBuffer2:gfxBuffers[1],gfxCounters:gfxCounters,audioSamplesRemaining:audioSamplesRemaining,timestamp:timestamp},[gfxBuffers[0].buffer,gfxBuffers[1].buffer,gfxCounters.buffer,audioSamplesRemaining.buffer,timestamp.buffer])}catch(e){postMessage({messageID:0,gfxBuffer1:gfxBuffers[0],gfxBuffer2:gfxBuffers[1],gfxCounters:gfxCounters,audioSamplesRemaining:audioSamplesRemaining,timestamp:timestamp})}self.onmessage=function(e){var r=e.data;switch(0|r.messageID){case 0:Iodine.play();break;case 1:Iodine.pause();break;case 2:Iodine.restart();break;case 3:Iodine.setIntervalRate(+r.payload),changeTimer(0|r.payload);break;case 4:Iodine.attachGraphicsFrameHandler(graphicsFrameHandler);break;case 5:Iodine.attachAudioHandler(audioHandler);break;case 6:Iodine.enableAudio();break;case 7:Iodine.disableAudio();break;case 8:Iodine.toggleSkipBootROM(!!r.payload);break;case 9:Iodine.toggleDynamicSpeed(!!r.payload);break;case 10:Iodine.attachSpeedHandler(speedHandler);break;case 11:Iodine.keyDown(0|r.payload);break;case 12:Iodine.keyUp(0|r.payload);break;case 13:Iodine.incrementSpeed(+r.payload);break;case 14:Iodine.setSpeed(+r.payload);break;case 15:Iodine.attachBIOS(r.payload);break;case 16:Iodine.attachROM(r.payload);break;case 17:Iodine.exportSave();break;case 18:Iodine.attachSaveExportHandler(saveExportHandler);break;case 19:Iodine.attachSaveImportHandler(saveImportHandler);break;case 20:processSaveImportSuccess(r.payload);break;case 21:processSaveImportFail();break;case 22:Iodine.toggleOffthreadGraphics(!!r.payload);break;case 23:Iodine.attachPlayStatusHandler(playStatusHandler)}};var graphicsFrameHandler={copyBuffer:function(e){var r=0|gfxCounters[0],a=0|gfxCounters[1];(0|a)!=(2+(0|r)|0)&&(gfxBuffers[1&a].set(e),Atomics.store(gfxCounters,1,1+(0|a)|0))}},audioHandler={initialize:function(e,r,a,i,s,t){for(r=+r,audioBufferSize=(0|(a|=0))*(0|(e|=0))|0,audioBufferSizeMask=1;(0|audioBufferSize)>=(0|audioBufferSizeMask);)audioBufferSizeMask=audioBufferSizeMask<<1|1;audioBufferSize=1+(0|audioBufferSizeMask)|0,audioBuffer=getSharedFloat32Array(0|audioBufferSize),audioCounters=getSharedInt32Array(2);try{postMessage({messageID:1,channels:0|e,sampleRate:+r,bufferLimit:0|a,audioBuffer:audioBuffer,audioCounters:audioCounters},[audioBuffer.buffer,audioCounters.buffer])}catch(i){postMessage({messageID:1,channels:0|e,sampleRate:+r,bufferLimit:0|a,audioBuffer:audioBuffer,audioCounters:audioCounters})}},push:function(e,r,a){r|=0,a|=0;var i=0|audioCounters[0],s=0|audioCounters[1],t=(0|s)&(0|audioBufferSizeMask)|0,o=(0|s)-(0|i)|0;o=(0|audioBufferSize)-(0|o)|0;var n=(0|a)-(0|r)|0;for(a=(0|r)+(0|(n=0|Math.min(0|n,0|o)))|0;(0|r)<(0|a);r=1+(0|r)|0)audioBuffer[0|t]=+e[0|r],(0|(t=1+(0|t)|0))==(0|audioBufferSize)&&(t=0);s=(0|s)+(0|n)|0,Atomics.store(audioCounters,1,0|s)},register:function(){postMessage({messageID:2})},unregister:function(){postMessage({messageID:3})},setBufferSpace:function(e){postMessage({messageID:4,audioBufferContainAmount:0|e})},remainingBuffer:function(){return(0|(0|this.remainingBufferShared()))+(0|(0|audioSamplesRemaining[0]))|0},remainingBufferShared:function(){var e=0|audioCounters[0];return 0|((0|(0|audioCounters[1]))-(0|e)|0)}};function saveImportHandler(e,r,a){postMessage({messageID:5,saveID:e}),saveImportPool.push([r,a])}function saveExportHandler(e,r){postMessage({messageID:6,saveID:e,saveData:r})}function speedHandler(e){postMessage({messageID:7,speed:e})}function processSaveImportSuccess(e){saveImportPool.shift()[0](e)}function processSaveImportFail(){saveImportPool.shift()[1]()}function playStatusHandler(e){e|=0,postMessage({messageID:8,playing:0|e}),0==(0|e)?timerHandle&&(clearInterval(timerHandle),timerHandle=null):timerHandle||initTimer(0|timerRate)}function changeTimer(e){e|=0,timerHandle&&(clearInterval(timerHandle),initTimer(0|e)),timerRate=0|e}function initTimer(e){(0|(e|=0))>0&&(timerHandle=setInterval((function(){Iodine.timerCallback(timestamp[0]>>>0)}),0|e))}